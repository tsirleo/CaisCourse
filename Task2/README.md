# Динамическое инструментирование бинарного кода

Задание посвящено ознакомлению с системой динамического инструментирования бинарного кода Pin. Следующее описание гипотетической ситуации служит неформальной постановкой задачи.

В наши руки попала «сырая» версия крипто-локера, в котором ещё не реализован функционал по обходу файловой системы и вымоганию денег, но уже реализовано само шифрование. Особая удача заключается в том, что среди полученных материалов было несколько версий программы шифрования **encrypt** и несколько версий программы расшифровки **decrypt**. Наши специалисты провели предварительный анализ полученных образцов и выяснили следующее.

1. Все бинарные модули собраны статически и из них не удалены символы. 
2. Судя по всему, все программы используют алгоритм симметричного шифрования _Blowfish_ (термин «симметричное шифрование» означает, что для шифрования и дешифрования применяется один и тот же ключ) в реализации библиотеки **libcrypto** из пакета OpenSSL. В символах мы видим функцию **_BF_set_key_**, которая используется для задания ключа шифрования (ключом при этом считается буфер, задаваемый параметрами **data** и **len**, а не внутренняя структура библиотеки **key**). 
3. Разные версии encrypt и разные версии decrypt работают с разными ключами. Мы не смогли найти пару encrypt-decrypt, которая бы работала с одним и тем же ключом. 
4. Разные версии программ также отличаются адресами символов, но сами символы в них одинаковые.

Необходимо реализовать два Pin-инструмента: первый, который позволит в динамике извлечь используемый ключ из одной из версий программы **encrypt**, и второй, который заменит используемый ключ в программе **decrypt** на заданный. Таким образом мы сможем получить все ключи шифрования и применить их для расшифровки.

Для работы передаётся одна версия **encrypt**, одна версия **decrypt** (с разными используемыми ключами), а также один файл, зашифрованный вашей версией **encrypt**, с названием **encrypted.sample.** 

## Подзадачи

Далее формально описаны подзадачи, которые необходимо решить. Подзадачи решаются в прямом порядке: для решения второй сначала потребуется решить первую. 

### Подзадача 1: извлечение ключа шифрования из программы encrypt

В рамках данной подзадачи необходимо реализовать Pin-инструмент, позволяющий во время работы программы **encrypt** получить используемый ключ шифрования (в виде набора байтов) и сохранить его в двоичном виде в файл **_encrypt.key_** в текущем каталоге. 

### Подзадача 2: динамическая модификация программы decrypt с подменой ключа шифрования

В рамках данной подзадачи необходимо реализовать Pin-инструмент, позволяющий во время работы программы **decrypt** подменить используемый ей ключ шифрования на расположенный в текущем каталоге в файле **_decrypt.key_**. 

## Запуск инструмента:

```shell 
g++ pintool_encrypt.cpp -o pinenc
./pinenc

g++ pintool_decrypt.cpp -o pindec
./pindec
```

